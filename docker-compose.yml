
services:
  authorization.web:
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_HTTP_PORTS=5000
    image: authorizationapi
    container_name: AuthorizationAPI
    build:
      context: .
      args:
      - BUILD_CONFIGURATION=Development
      dockerfile: AuthorizationAPI/AuthorizationAPI.Web/Dockerfile
    ports:
    - "5000:5000"
    depends_on:
    - mssql-server
      # mssql-server:
      #   condition: service_healthy

  offices.web:
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_HTTP_PORTS=5001
    image: officesapi
    container_name: OfficesAPI
    build:
      context: .
      args:
      - BUILD_CONFIGURATION=Development
      dockerfile: OfficesAPI/OfficesAPI.Web/Dockerfile
    ports:
    - "5001:5001"
    depends_on:
    - authorization.web

  profiles.web:
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_HTTP_PORTS=5002
    image: profilesapi
    container_name: ProfilesAPI
    build:
      context: .
      args:
      - BUILD_CONFIGURATION=Development
      dockerfile: ProfilesAPI/ProfilesAPI.Web/Dockerfile
    ports:
    - "5002:5002"
    depends_on:
    - authorization.web
    - mssql-server
    - profiles-azure-blob-storage


  mssql-server:
    image: mcr.microsoft.com/mssql/server:2019-latest
    container_name: mssql-server
    environment:
      ACCEPT_EULA: Y
      SA_PASSWORD: SecretPassword123
    volumes:
    - ./sqlserver/data:/var/opt/mssql/data
    - ./sqlserver/log:/var/opt/mssql/log
    ports: 
    - "1433:1433"
    # healthcheck:
    #   test: ["CMD", "/opt/mssql-tools/bin/sqlcmd", "-S", "http://localhost:1433", "-U", "sa", "-P", "SecretPassword123", "-Q", "SELECT 1", "||", "exit 1"]
    #   interval: 10s
    #   timeout: 5s
    #   retries: 4
    #   start_period: 15s

      # test: /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P "SecretPassword123" -Q "SELECT 1" -b -o /dev/null
      # test: /opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P SecretPassword123 -Q "SELECT 1" || exit 1
      # test: /opt/mssql-tools/bin/sqlcmd -S localhost -U SA -P "SecretPassword123" -Q "Select 1" -b -o /dev/null
      # test: ["CMD-SHELL", "/opt/mssql-tools/bin/sqlcmd -S localhost -U sa -P \"SecretPassword123\" -Q \"SELECT 1\" || exit 1"]

  profiles-azure-blob-storage:
    image: mcr.microsoft.com/azure-storage/azurite:latest
    container_name: profiles.azure-blob-storage
    volumes:
    - ./.containers/azure-blob-storage:/data
    ports:
    - "10000:10000"
    command: "azurite-blob --blobHost 0.0.0.0 -l /data"